<script>
  const SUPABASE_URL = "https://oqtzrphkronwicmdytgj.supabase.co";
  const AUTH_URL = "https://oqtzrphkronwicmdytgj.supabase.co/functions/v1/oauth-authorize";

  const params = new URLSearchParams(window.location.search);
  const redirectUri = params.get("redirect_uri");
  const state = params.get("state");

  const errorBox = document.getElementById("error");
  const btn = document.getElementById("signInBtn");

  btn.addEventListener("click", async () => {
    errorBox.innerText = "Clicked. Starting sign inâ€¦";

    if (!redirectUri) {
      errorBox.innerText =
        "Missing redirect_uri (must open from Alexa account linking).";
      return;
    }

    try {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      const res = await fetch(AUTH_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password, redirect_uri: redirectUri, state }),
      });

      const json = await res.json();
      if (!res.ok || !json.code) {
        errorBox.innerText = json.error || "Login failed";
        return;
      }

      const url = new URL(redirectUri);
      url.searchParams.set("code", json.code);
      if (state) url.searchParams.set("state", state);
      window.location.href = url.toString();
    } catch (e) {
      errorBox.innerText = "JS error: " + e;
    }
  });
</script>
